# План разработки Telegram-бота

## Отчет о прогрессе

| Итерация | Описание функционала             | Статус        | Тесты        |
|----------|---------------------------------|---------------|--------------|
| 1        | Инициализация бота и `/start`   | ✅ Завершено   | ✅           |
| 2        | Диалог с LLM                    | ✅ Завершено  | ✅           |
| 3        | Контекст диалога (история)      | ❌ Не начато  |              |
| 4        | Конфигурирование                | ❌ Не начато  |              |
| 5        | Логгирование                    | ❌ Не начато  |              |

---

## Итерационный план

### Итерация 1: Инициализация бота и команда `/start`

- [x] Создать базовую структуру проекта (файлы: `main.py`, `config.py`, `llm_service.py`, `handlers.py`, `utils.py`, `Makefile`, `requirements.txt`).
- [x] Настроить `uv` и сгенерировать `requirements.txt`.
- [x] Добавить в `config.py` загрузку `TELEGRAM_BOT_TOKEN` из `.env`.
- [x] Инициализировать `aiogram` бота в `main.py`.
- [x] Реализовать обработчик команды `/start` в `handlers.py`, который будет приветствовать пользователя.
- [x] Настроить запуск бота с `polling` в `main.py`.
- [x] Добавить в `Makefile` команду для запуска бота.
- [x] **Тестирование:** Запустить бота, отправить `/start` и убедиться, что он отвечает.

### Итерация 2: Базовый диалог с LLM

- [x] Добавить в `config.py` загрузку `OPENROUTER_API_KEY` и `LLM_MODEL` из `.env`.
- [x] Реализовать в `llm_service.py` функцию для отправки запроса в LLM через `openai` клиент, используя Openrouter.
- [x] Добавить обработчик текстовых сообщений в `handlers.py`.
- [x] В обработчике текстовых сообщений вызывать `llm_service.py` для получения ответа от LLM.
- [x] Отправлять полученный ответ от LLM пользователю.
- [x] **Тестирование:** Запустить бота, отправить любой вопрос и убедиться, что LLM отвечает.

### Итерация 3: Контекст диалога (история)

- [ ] В `config.py` добавить `LLM_SYSTEM_PROMPT` и `CHAT_HISTORY_LENGTH`.
- [ ] Реализовать механизм хранения истории диалога в оперативной памяти (например, словарь в `main.py` или `handlers.py`).
- [ ] Модифицировать обработчики сообщений для сохранения истории.
- [ ] Модифицировать `llm_service.py` для включения системного промпта и истории последних `CHAT_HISTORY_LENGTH` сообщений в запрос к LLM.
- [ ] **Тестирование:** Запустить бота, вести диалог, убедиться, что LLM помнит предыдущие реплики.

### Итерация 4: Доработка конфигурирования

- [ ] Добавить более надежную обработку отсутствующих переменных окружения в `config.py` (например, с выдачей ошибок).
- [ ] **Тестирование:** Удалить некоторые переменные из `.env` и убедиться, что приложение корректно сообщает об ошибках.

### Итерация 5: Базовое логгирование

- [ ] Настроить базовое логгирование с использованием `logging` в `main.py`.
- [ ] Добавить информационные логи о старте бота, получении сообщений, отправке запросов/ответов LLM.
- [ ] Добавить логи ошибок при сбоях.
- [ ] **Тестирование:** Запустить бота, взаимодействовать с ним, вызвать ошибку (например, неверный API ключ) и проверить вывод логов в консоль.
